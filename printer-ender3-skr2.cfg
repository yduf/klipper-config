# This file contains common pin mappings for the BIGTREETECH SKR mini
# E3 v2.0. To use this config, the firmware should be compiled for the
# STM32F103 with a "28KiB bootloader" and USB communication. Also,
# select "Enable extra low-level configuration options" and configure
# "GPIO pins to set at micro-controller startup" to "!PA14".

# The "make flash" command does not work on the SKR mini E3. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini E3 with that SD card.


### Macro are inserted on top

## https://github.com/boardthatpowder/klipper-firmware/blob/master/printer.cfg
[gcode_macro PARK_HEAD]
description: Park head to a predefined position
default_parameter_X: 0
default_parameter_Y: 0
default_parameter_Z: 10  # Z is used in relative mode below
gcode:
    SAVE_GCODE_STATE NAME=PARK_HEAD_state
    G91                     ; relative positioning
    {% if printer.extruder.can_extrude %}
      G1 E-.8 F2700           ; retract filament
    {% endif %}
    G1 Z{Z}                 ; lift z slightly             
    G90                     ; absolute positioning
    G1 X{X} Y{Y}  F3000     ; park the head (leaving Z the same)
    RESTORE_GCODE_STATE name=PARK_HEAD_state

[gcode_macro PARK]
description: alias to PARK_HEAD
gcode: PARK_HEAD

[gcode_macro UNLOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
    M117 Unloading Filament
    G91                 ; relative positioning
    G1 E5.0 F1200       ; extrude a little
    G1 E3.0 F1600       ; extrude a little more
    G92 E0.0
    G1 E-13.14 F7000    ; retract
    ; retract a lot more (bowden tube), but must be split according to max_extrude_only_distance (50.0)
    G1 E-50 F3000     
    G1 E-50 F3000        
    G92 E0.0
    RESTORE_GCODE_STATE name=UNLOAD_FILAMENT_state

[gcode_macro M702]
description: unload filament
gcode:
    UNLOAD_FILAMENT

[gcode_macro LOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=LOAD_FILAMENT
    G91                 ; relative positioning
    G1 E25.0 F1000      ; extrude
    ; G1 E435 F2500       ; extrude a lot more bowden tube
    G4 P900             ; dwell
    G1 E45.0 F2500      ; extrude a littel more
    RESTORE_GCODE_STATE name=LOAD_FILAMENT

######################################################################
# Filament Change
######################################################################

# M600: Filament Change. This macro will pause the printer, move the
# tool to the change position, and retract the filament 50mm. Adjust
# the retraction settings for your own extruder. After filament has
# been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.

# enable pause resume
[pause_resume]
#recover_velocity: 50.
#   When capture/restore is enabled, the speed at which to return to
#   the captured position (in mm/s). Default is 50.0 mm/s.

# enable respond
[respond]
#default_type: echo
#   Sets the default prefix of the "M118" and "RESPOND" output to one
#   of the following:
#       echo: "echo: " (This is the default)
#       command: "// "
#       error: "!! "
#default_prefix: echo:
#   Directly sets the default prefix. If present, this value will
#   override the "default_type".

# Filament change
[gcode_macro M600]
gcode:
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    PARK_HEAD
    ; UNLOAD_FILAMENT ; call M600 could as well allow to put bolt inside a piece
    ; SET_IDLE_TIMEOUT TIMEOUT=3600
    RESTORE_GCODE_STATE NAME=M600_state


# See docs/Config_Reference.md for a description of parameters.


# Ender 3 config 
[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC0
position_endstop: 0
# extended for probing over screw / position is outside bed for head
position_max: 245
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.580
hold_current: 0.500
stealthchop_threshold: 999999

[stepper_y]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC1
position_endstop: 0
# extended for probing over screw / position is outside bed for head
position_max: 240
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.580
hold_current: 0.500
stealthchop_threshold: 999999

[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 8
## without bltouch
# endstop_pin: ^PC2
# position_endstop: 0.0
## with bltouch as endstop
endstop_pin: probe:z_virtual_endstop
position_min: -2            # get some margin for probe calibration
position_max: 250

### default for z axis endstop
# [safe_z_home]
# home_xy_position: 0, 0
# z_hop:10

## setup for bltouch
[safe_z_home]
# start on screw pos
home_xy_position: 100, 100
z_hop:10

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.580
hold_current: 0.500
stealthchop_threshold: 999999

[endstop_phase stepper_z]

[extruder]
step_pin: PB3
dir_pin: !PB4
enable_pin: !PD2
microsteps: 16
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC8
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250
#max_extrude_only_distance: 50.0
#   Maximum length (in mm of raw filament) that an extrude only move
#   may be. If an extrude only move requests a distance greater than
#   this value it will cause an error to be returned. The default is
#   50mm.

[tmc2209 extruder]
uart_pin: PC11
tx_pin: PC10
uart_address: 3
run_current: 0.650
hold_current: 0.500
stealthchop_threshold: 999999

[heater_bed]
heater_pin: PC9
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC3
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

[heater_fan nozzle_cooling_fan]
pin: PC7

[fan]
pin: PC6

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_37FFD4055358353212840843-if00

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[static_digital_output usb_pullup_enable]
pins: !PA14

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PB5,  EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8,  EXP1_9=<GND>,
    EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PB15, EXP1_10=<5V>

# See the sample-lcd.cfg file for definitions of common LCD displays.

[display]
lcd_type: st7920
cs_pin: EXP1_7
sclk_pin: EXP1_6
sid_pin: EXP1_8
encoder_pins: ^EXP1_5, ^EXP1_3
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8

[output_pin beeper]
pin: EXP1_1


### Screw positions for manual levelling
[bed_screws]
screw1: 32,32
screw2: 203,32
screw3: 203,203
screw4: 32,203
screw5: 117,117

## BL Touch
[bltouch]
sensor_pin: ^PC14
control_pin: PA1
x_offset: -48.0
y_offset: -10.0
z_offset: 2.400

## align mesh boundary on screw (depends on head capability)
[bed_mesh]
speed: 120
horizontal_move_z: 5
mesh_min: 32,32
mesh_max: 195, 195
probe_count: 3,3

# ###
# # Custom Menu
# # [menu __main __sdcard]
# # type: disabled

# ## 
[menu __main __prepare]
type: list
name: Prepare

[menu __main __prepare  __home]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Home All
gcode: G28

## auto leveling
[menu __main __prepare __auto_bed_leveling]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Auto mesh
gcode: 
  {% if printer.toolhead.homed_axes != "xyz" %}
    {action_respond_info("Please home XYZ first")}
  {% else %}
    BED_MESH_CALIBRATE
    PARK_HEAD
  {% endif %}

## Manual Bed leveling helper
[menu __main __prepare __manual_bed_leveling]
type: list
name: Manual Leveling

[menu __main __prepare __manual_bed_leveling __start]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Start adjust
gcode: BED_SCREWS_ADJUST

[menu __main __prepare __manual_bed_leveling __accept]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: I Accept screw
gcode: accept

[menu __main __prepare __manual_bed_leveling __adjust]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: I Adjusted screw
gcode: adjusted

[menu __main __prepare __manual_bed_leveling __abort_screws]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Abort
gcode: abort

